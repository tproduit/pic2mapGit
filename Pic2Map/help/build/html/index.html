<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Welcome to Pic2Map’s documentation! &mdash; Pic2Map 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Pic2Map 0.1 documentation" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">Pic2Map 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="welcome-to-pic2map-s-documentation">
<h1>Welcome to Pic2Map&#8217;s documentation!<a class="headerlink" href="#welcome-to-pic2map-s-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<p>This plugin has been developed during  Gillian Milani&#8217;s master thesis at EPFL in the <a class="reference external" href="http://lasig.epfl.ch/">lASIG laboratory</a>. The plugin development is based on the following work: Timothée Produit and Devis Tuia. An open tool to register landscape oblique images and generate their synthetic models. In Open Source Geospatial Research and Education Symposium (OGRS), 2012.</p>
<p>The plugin is still in its developement phasis and you can send your comments with us: gillian.milani at epfl.ch</p>
<a class="reference internal image-reference" href="_images/epfl_logo.png"><img alt="_images/epfl_logo.png" src="_images/epfl_logo.png" style="width: 200px;" /></a>
<p>Already aware of the plugin ? Go to the <a class="reference internal" href="#tricks"><em>Tricks for a comfortable experience</em></a> section !</p>
</div>
<div class="section" id="concepts">
<span id="index-0"></span><h1>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h1>
<p>Pic2Map allows you to do usual GIS works directly from a landscape picture.
In essence, the plugin brings the capability to work with a perspective view
instead of the usual orthogonal view. For achieving this goal, the position, the orientation, as well as internal
parameters of the camera need to be determined from ground control points (GCPs). This allows interaction between the picture
and the Digital Elevation Model (DEM).</p>
<a class="reference internal image-reference" href="_images/oblique2.png"><img alt="_images/oblique2.png" class="align-center" src="_images/oblique2.png" style="width: 300px;" /></a>
<p>The Pic2Map plugin brings more than new capabilities in QGIS, it brings also new people!
Consider using this tool if your deal with one of the following situations:</p>
<ul class="simple">
<li>Creation of raster with oblique photography</li>
<li>Determination of camera position</li>
<li>Rapid mapping after disaster such as avalanche or landslide</li>
<li>Recursive mapping, such as map of snow melting or traffic jams</li>
<li>Mapping from terrestrial images</li>
<li>Change detection from terrestrial images</li>
<li>Augmented reality in landscape picture</li>
</ul>
<p>The steps to use Pic2Map are the following:</p>
<ol class="arabic simple">
<li>Load a landscape picture with a corresponding DEM</li>
<li>Determine the pose of the camera by GCP or navigation in virtual view</li>
<li>Use the monoplotter for standard GIS works on oblique picture</li>
</ol>
</div>
<div class="section" id="installation-and-testing-dataset">
<span id="index-1"></span><h1>Installation and testing dataset<a class="headerlink" href="#installation-and-testing-dataset" title="Permalink to this headline">¶</a></h1>
<p>You can download the plugin from the following repository: <a class="reference external" href="https://documents.epfl.ch/groups/l/la/lasig-unit/www/pic2map/lasigRepository.xml">https://documents.epfl.ch/groups/l/la/lasig-unit/www/pic2map/lasigRepository.xml</a></p>
<p>For adding a the new repository to qgis, go to <em class="menuselection">Plugins ‣ Manage ans install plugins... ‣ settings Tab ‣ Add...</em> and add the repository url. Then, you can enable the plugin by searching the plugin list.</p>
<p>A technical introduction video can be found <a class="reference external" href="https://www.youtube.com/watch?v=3Wic6PYUaKU">here</a> .The original plugin folder contains a data set for testing the plugin. Extract the data outside the original folder (for example on the desktop) for being able to use them.</p>
</div>
<div class="section" id="system-requirement">
<span id="index-2"></span><h1>System requirement<a class="headerlink" href="#system-requirement" title="Permalink to this headline">¶</a></h1>
<p>QGIS 2.2 is required</p>
<p>You need the 32-bits version of QGIS for running the plugin ! (because of pyopengl...)</p>
<p>Currently, the plugin has been used without obstacles on following configuration:
Window 7, Intel Core 2 Duo 2.5 GHz, 4 GB RAM, GPU nvidia 8700 GT (512 MB)
Window XP SP3, Intel Core 2 Duo 2.2 GHz, 2 GB RAM, GPU nvidia Quadro NVS 135M (without support of Framebuffer)
virtual machine Ubuntu 14.04 LTS, 4 GB RAM</p>
<p>OpenGL 3.0 is required for Framebuffer support. If Framebuffer is not supported, some tool capabilities are restricted.</p>
<p>You may have problem with Opengl.GL under Ubuntu. In this case, use the following commands and try again:</p>
<ul class="simple">
<li>sudo easy_install pyopengl</li>
<li>sudo apt-get install python python-opengl python-qt4 python-qt4-gl</li>
</ul>
</div>
<div class="section" id="data-requirement">
<span id="index-3"></span><h1>Data requirement<a class="headerlink" href="#data-requirement" title="Permalink to this headline">¶</a></h1>
<p>For using this plugin, you will need:</p>
<ul class="simple">
<li>An oblique picture (png, jpeg, etc.)</li>
<li>A DEM in tiff format</li>
<li>Incidentally an orthoimage</li>
</ul>
<p>The DEM has to be consistent with the picture.
It means that you can only work with parts of your picture corresponding to the DEM area.
The terrain 3D is not generated from the picture. You have to know it before.
The speed of the plugin depends on the size of DEM, so try to balance between performance and quality.
Tif files with 1000 x 1000 pixels can be considered as a limit for a comfortable work.
It corresponds to a square of 30km width with ASTER Dem, which is much more than needed.</p>
<span class="target" id="index-4"></span><p id="index-5">If you don’t have a DEM, follow these steps:</p>
<ol class="arabic simple">
<li>Go on <a class="reference external" href="http://earthexplorer.usgs.gov/">http://earthexplorer.usgs.gov/</a> and download a tile of ASTER or SRTM</li>
<li>Check which UTM zone you need on <a class="reference external" href="http://upload.wikimedia.org/wikipedia/commons/e/ed/Utm-zones.jpg">wikipedia</a></li>
<li>Use the tool <em class="menuselection">Raster ‣ Projections ‣ Warp</em> and reproject it from WGS84 (EPSG:4326) the to the ETRS89 / UTM spatial reference system.</li>
<li>Use the tool <em class="menuselection">Raster ‣ Extraction ‣ Clipper</em> for taking only the area that you need.</li>
<li>Incidentally use the tool <em class="menuselection">Raster ‣ Conversion ‣ Translate</em> for rescaling your DEM or ortho-image</li>
</ol>
</div>
<div class="section" id="initialization">
<span id="index-6"></span><h1>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h1>
<p>Required data are a landscape picture and a DEM. You can optionally give an orthoimage.
The orthoimage must have the same SRS, even if they don&#8217;t need to superimpose exactly.
If you choose to use an ortho-image, the 3D view will appears black outside the bounding box of the orthoimage.
If you prefer working with shaded DEM, don’t use ortho-image.
Moreover, your orthoimage must not be heavier than few Mb.
After loading the data, <strong>check that the Project SRS is the same as your DEM projection system</strong>.
If not or if you’re not sure, right click on the DEM layer and set the project SRS with DEM SRS.
After adding layers from the openLayers plugin, you have to reset the project SRS from the DEM.</p>
<a class="reference internal image-reference" href="images/setProject.png"><img alt="images/setProject.png" src="images/setProject.png" style="width: 300px;" /></a>
</div>
<div class="section" id="pose-estimation">
<span id="index-7"></span><h1>Pose estimation<a class="headerlink" href="#pose-estimation" title="Permalink to this headline">¶</a></h1>
<p>The pose includes the orientation and position of the camera.
Moreover, the focal need to be estimated. The central point is fixed to the center of the picture.
These two last are internal camera parameters.
There are two approaches for the pose estimation.
Either you recognize some features present in the picture and in the canvas which are the GCPs,
either you opt for a more “gaming” approach, called here Virtual 3D.</p>
<table border="1" class="docutils" id="my-drawn-table-1">
<colgroup>
<col width="12%" />
<col width="43%" />
<col width="45%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>&nbsp;</td>
<td>GCP Approach</td>
<td>Virtual 3D Approach</td>
</tr>
<tr class="row-even"><td>Advantages</td>
<td><p class="first">Some known parameter can be fixed</p>
<p>The result is best mathematically rigorous</p>
<p class="last">The focal is usually well estimated</p>
</td>
<td><p class="first">An acceptable estimation can be achieved rapidly</p>
<p>The method is simple and clear for everyone</p>
<p class="last">The horizon line can be precisely  adjusted</p>
</td>
</tr>
<tr class="row-odd"><td>Disadvantages</td>
<td><p class="first">Precision is related to the number of GCP</p>
<p>Precision is related to the quality of GCP</p>
<p class="last">Digitalization of GCP is time consuming</p>
</td>
<td><p class="first">Pose estimate usually is not accurate</p>
<p>The focal is not easily determined</p>
<p class="last">We do not have directly a measure of the precision</p>
</td>
</tr>
</tbody>
</table>
<p>It is possible to mix both approaches:</p>
<ul class="simple">
<li>Start with virtual 3D approach and save the pose in KML</li>
<li>Restart with GCP approach, load the KML pose</li>
<li>Use the 3D view at the current pose for GCP digitalization</li>
</ul>
<div class="section" id="gcp-approach">
<span id="index-8"></span><h2>GCP approach<a class="headerlink" href="#gcp-approach" title="Permalink to this headline">¶</a></h2>
<p>The standard way of pose estimation is to 2D-3D correspondences detected in the picture and on the DEM.
The correspondences exist here as point features and are called Ground Control Point (GCP).
Each GCP helps to gain precision for the pose estimation.
A minimum of 6 points are required for solving the problem.
However, it is recommended to use more than 6 GCPs, at the very least 10.
We recommend using the 3D viewer, which ease the recognition of GCPs, instead of the Qgis Canvas.</p>
<a class="reference internal image-reference" href="_images/GCP.png"><img alt="_images/GCP.png" class="align-center" src="_images/GCP.png" style="width: 300px;" /></a>
<p>We make use standards algorithm in computer vision for estimation of the pose.
Points in the picture have to be linked to coordinates in world (or local) coordinate system.
Direct Linear Transform (DLT) algorithm is used for estimation of the position.
Several parameters can be fixed trough a least square refinement of the DLT.</p>
<p>The GCP digitalization interface is divided in five main areas:</p>
<ol class="arabic simple">
<li>The scene</li>
<li>The GCP table</li>
<li>The GCP toolbar</li>
<li>The scene toolbar</li>
<li>The 3D toolbar</li>
</ol>
<a class="reference internal image-reference" href="_images/GCPApproach.png"><img alt="_images/GCPApproach.png" class="align-center" src="_images/GCPApproach.png" style="width: 600px;" /></a>
<div class="section" id="the-scene">
<span id="index-9"></span><h3>The Scene<a class="headerlink" href="#the-scene" title="Permalink to this headline">¶</a></h3>
<p>It’s basically a view of the picture.
You select a GCP in the table and then click on the scene for getting the picture coordinates.
The scene toolbar (4) helps you to navigate inside the picture and the canvas.</p>
</div>
<div class="section" id="the-gcp-table">
<span id="index-10"></span><h3>The GCP table<a class="headerlink" href="#the-gcp-table" title="Permalink to this headline">¶</a></h3>
<p>The two first columns are the 2D picture coordinates.
The three following are the world coordinates (East, Nord and altitude).
To fill the table, select a line and click on the scene to get image coordinates. Click on its correspondence in the QGis canvas for the world coordinates.
There is also a ways to get 3D coordinates from the 3D viewer by <tt class="kbd docutils literal"><span class="pre">ctrl</span> <span class="pre">+</span> <span class="pre">Left</span> <span class="pre">Click</span></tt>: . In fact, this last option is recommended</p>
<p>The fifth one is a column of GCP state. You can disable the GCP for the pose estimation.
A projection will be done, even if it’s not used by the algorithm. In the last column, you have an indication of error.
It is exactly the 3D distance between the world coordinate and the reprojection of picture GCP.</p>
</div>
<div class="section" id="the-gcp-toolbar">
<span id="index-11"></span><h3>The GCP Toolbar<a class="headerlink" href="#the-gcp-toolbar" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="_images/toolbar1.png"><img alt="toolbar1" src="_images/toolbar1.png" style="width: 2em;" /></a>  Create a new line in the GCP table</p>
<p><a class="reference internal" href="_images/toolbar2.png"><img alt="toolbar2" src="_images/toolbar2.png" style="width: 2em;" /></a>  Delete the selected line in the GCP table</p>
<p><a class="reference internal" href="_images/toolbar3.png"><img alt="toolbar3" src="_images/toolbar3.png" style="width: 2em;" /></a>  Save the GCP table</p>
<p><a class="reference internal" href="_images/toolbar4.png"><img alt="toolbar4" src="_images/toolbar4.png" style="width: 2em;" /></a>  Load a GCP table</p>
<p><a class="reference internal" href="_images/toolbar13.png"><img alt="toolbar13" src="_images/toolbar13.png" style="width: 2em;" /></a>  Remove the reprojected GCPs after a pose estimation</p>
<p><a class="reference internal" href="_images/toolbar8.png"><img alt="toolbar8" src="_images/toolbar8.png" style="width: 2em;" /></a>  Change display setting of GCPs</p>
</div>
<div class="section" id="the-scene-toolbar">
<span id="index-12"></span><h3>The scene toolbar<a class="headerlink" href="#the-scene-toolbar" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="_images/toolbar5.png"><img alt="toolbar5" src="_images/toolbar5.png" style="width: 2em;" /></a>  Zoom in the scene</p>
<p><a class="reference internal" href="_images/toolbar6.png"><img alt="toolbar6" src="_images/toolbar6.png" style="width: 2em;" /></a>  Zoom out the scene</p>
<p><a class="reference internal" href="_images/toolbar7.png"><img alt="toolbar7" src="_images/toolbar7.png" style="width: 2em;" /></a>  Toogle the Pan tool for the scene</p>
<p><a class="reference internal" href="_images/toolbar12.png"><img alt="toolbar12" src="_images/toolbar12.png" style="width: 2em;" /></a>  Zoom on the selected GCP in the scene and in the canvas</p>
</div>
<div class="section" id="the-3d-toolbar">
<span id="index-13"></span><h3>The 3D toolbar<a class="headerlink" href="#the-3d-toolbar" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="_images/toolbar9.png"><img alt="toolbar9" src="_images/toolbar9.png" style="width: 2em;" /></a>  Open the pose estimation dialog box</p>
<p><a class="reference internal" href="_images/toolbar10.png"><img alt="toolbar10" src="_images/toolbar10.png" style="width: 2em;" /></a>  Open the 3D viewer.</p>
<p><a class="reference internal" href="_images/toolbar11.png"><img alt="toolbar11" src="_images/toolbar11.png" style="width: 2em;" /></a>  Close the GCP digitalization window and open the monoplotter</p>
<p><a class="reference internal" href="_images/toolbar14.png"><img alt="toolbar14" src="_images/toolbar14.png" style="width: 2em;" /></a>  Show information contain in EXIF</p>
<p><a class="reference internal" href="_images/toolbar16.png"><img alt="toolbar16" src="_images/toolbar16.png" style="width: 2em;" /></a>  Save current pose estimation in KML file</p>
<p><a class="reference internal" href="_images/toolbar15.png"><img alt="toolbar15" src="_images/toolbar15.png" style="width: 2em;" /></a>  Load a pose estimation from KML file</p>
<p>Information about the motion in 3D viewer:</p>
<ul class="simple">
<li><tt class="kbd docutils literal"><span class="pre">Left</span> <span class="pre">mouse</span> <span class="pre">button</span> <span class="pre">pressed</span></tt>: move left-right an up-down</li>
<li><tt class="kbd docutils literal"><span class="pre">Right</span> <span class="pre">mouse</span> <span class="pre">button</span> <span class="pre">pressed</span></tt>; rotate on the tilt and azimuth</li>
<li><tt class="kbd docutils literal"><span class="pre">Wheel</span></tt>: go front and back (Press wheel for a finer placement)</li>
</ul>
<p>Information about the capabilites in 3D viewer:</p>
<ul class="simple">
<li><tt class="kbd docutils literal"><span class="pre">ctrl</span> <span class="pre">+</span> <span class="pre">Left</span> <span class="pre">Click</span></tt>: get 3D coordinates for selected GCP</li>
<li><tt class="kbd docutils literal"><span class="pre">alt</span> <span class="pre">+</span> <span class="pre">Left</span> <span class="pre">Click</span></tt>: fix the position of the camera on the DEM at the clicked position</li>
</ul>
</div>
</div>
<div class="section" id="virtual-3d-approach">
<span id="index-14"></span><h2>Virtual 3D approach<a class="headerlink" href="#virtual-3d-approach" title="Permalink to this headline">¶</a></h2>
<p>We make use of the ability of users to estimate position, orientation as well as the focal of the camera by navigating in the virtual landscape.
The pose estimation is done empirically.
The camera travel in the world until the precision of the calking is enough for application purposes.
You can save the pose estimation in KML file and open it directly on google earth.
It&#8217;s also possible to load pose of picture from google earth.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/virtual3D.png"><img alt="_images/virtual3D.png" src="_images/virtual3D.png" style="width: 600px;" /></a>
</div>
</div>
</div>
<div class="section" id="monoplotter">
<span id="index-15"></span><h1>Monoplotter<a class="headerlink" href="#monoplotter" title="Permalink to this headline">¶</a></h1>
<p>Once the pose is set, you can start to do usual GIS work with your picture.
Don’t forget that the correspondence is done by using the DEM.
So if you have bad quality DEM or bad pose estimation, the correspondence will be affected.
It is currently possible to work on points and polylines.
Polygons have not been yet integrated in the plugin for various reasons.</p>
<div class="section" id="visualization-of-layers">
<span id="index-16"></span><h2>Visualization of layers<a class="headerlink" href="#visualization-of-layers" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/visualisation.png"><img alt="_images/visualisation.png" class="align-center" src="_images/visualisation.png" style="width: 600px;" /></a>
<p>For visualizing layers in your picture, just add them to the canvas and press “refresh layers”.
The symbology will be the same as the one used in the canvas.
You can project simple, categorized or graduated symbology.
However, you cannot use complex symbology, like point represented by stars or double lines representations.
Labels present in the canvas will be also drawn in the monoplotter.
In this case, the font is not taken from the canvas.
You can press on “label settings” for controlling label appearance.</p>
<span class="target" id="index-17"></span></div>
<div class="section" id="digitalization">
<span id="index-18"></span><h2>Digitalization<a class="headerlink" href="#digitalization" title="Permalink to this headline">¶</a></h2>
<p>The synergy with the canvas is quite well done.
For digitalizing a new feature, make sure that the layer is in editing mode and the “new feature” button is toggled.</p>
<a class="reference internal image-reference" href="_images/edition.png"><img alt="_images/edition.png" src="_images/edition.png" style="width: 150px;" /></a>
<p>Then you can use <tt class="kbd docutils literal"><span class="pre">ctrl</span> <span class="pre">+</span> <span class="pre">Left</span> <span class="pre">Click</span></tt> on the monoplotter and digitize new features.
The precision of digitalization will depend on the quality of the DEM and on the quality of the pose estimation.</p>
</div>
<div class="section" id="measurements">
<span id="index-19"></span><h2>Measurements<a class="headerlink" href="#measurements" title="Permalink to this headline">¶</a></h2>
<p>There are two different tools for measuring. The &#8220;Measure on plane&#8221; button opens the standard QGIS measure tool and allow its use in the monoplotter.
The second &#8220;Measure 3D&#8221; button opens an independent which act directly on the DEM.</p>
<p><em>Measure on plane</em>
You can measure in the monoplotter as you would measure on the canvas by <tt class="kbd docutils literal"><span class="pre">ctrl</span> <span class="pre">+</span> <span class="pre">Left</span> <span class="pre">Click</span></tt>.
The measurements are done as if you would click from in the canvas at the projected location.
It means that the measurement is done on the ellipsoidal.
As explain in the technical documentation, the precision are related to the current canvas extent.
So if the precision is not sufficient, a better zoom has to be set in the canvas.</p>
<a class="reference internal image-reference" href="_images/mesurement.png"><img alt="_images/mesurement.png" class="align-center" src="_images/mesurement.png" style="width: 800px;" /></a>
<p><em>Measure 3D</em>
If you want to take into account the altitude, you can opt for the 3D measurement tool.
With the 3D measurement tool, measures are done directly with the 3D coordinates from the DEM.</p>
</div>
<div class="section" id="ortho-rectification-draping">
<span id="index-20"></span><h2>Ortho rectification (Draping)<a class="headerlink" href="#ortho-rectification-draping" title="Permalink to this headline">¶</a></h2>
<p>By draping is understood the coloring of each DEM profil with the picture data.
The process is quite similar to a standard ortho rectification for a satellite image.
A difference would be the need of a DEM in the current case instead of many images in photogrammetry.
For getting a georeferenced raster from your picture, just click on “Drape on DEM”, and then choose an area on the preview window.
Pull the mouse from up-left to the down-right direction. The pixel size can also be set. Some problems can arise if the resolution is too small.
Keep well designed value, in order of the resolution of your DEM.</p>
<a class="reference internal image-reference" href="_images/drapingSave2.png"><img alt="_images/drapingSave2.png" class="align-center" src="_images/drapingSave2.png" style="width: 800px;" /></a>
<p>You can save the raster in two format. Either in png, which will create an standard image, displayable from every image software. Either
you create a tiff raster, which will be geo-referenced and that you can open with your favorite GIS software.
The forth band of the geotiff raster can be used as transparency band.</p>
<p>The process used for draping the DEM provide high quality results.
It uses the best OpenGL features for texturing
heightmap with every detail of the picture.
If you are interested in the detail of the draping, you can consult documentation of openGL about texturing.</p>
</div>
</div>
<div class="section" id="tricks-for-a-comfortable-experience">
<span id="tricks"></span><h1>Tricks for a comfortable experience<a class="headerlink" href="#tricks-for-a-comfortable-experience" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Don&#8217;t forget to work always with the SRS of your DEM!</li>
</ul>
<p><em>About the DEM, orthoimage and picture</em>:</p>
<ul class="simple">
<li>If you&#8217;re not used to GIS world, get some help for getting a nice DEM. The four point in &#8220;Data requirement&#8221; can look simple, but troubles come pretty fast.</li>
<li>Don&#8217;t use a DEM with more than 1&#8216;000&#8216;000 pixels if high rate calculations are needed.</li>
<li>If you can get a better DEM than Aster or SRTM; don&#8217;t hesitate, it&#8217;s worth in most cases.</li>
<li>The plugin will tend to crash if you use large images (&gt; 10Mb). This is due to limitation on GPU for buffering (generally in scale of the screen wide)</li>
<li>If you have to use a large DEM, use an orthoimage if the initial loading is too slow. This last step would be skipped (calculation of shadow of DEM)</li>
</ul>
<p><em>About the pose estimation</em>:</p>
<ul class="simple">
<li>For getting GCP in world coordinates, try to use the 3D viewer first, it is much easier than on the orthogonal view.</li>
<li>Try to get GCP in every part of the picture. Then you can refine them by using OpenLayers plugin for example.</li>
<li>The best configuration for the GCPs is a cube. Don&#8217;t hesitate to put GCP at the bottom of mountain, not only at the top.</li>
<li>If you have no idea where the picture has been taking, just wait 1 or 2 years, we will find a solution...</li>
<li>If you still have no idea where the picture has been taking, but really want to use Pic2Map, you can navigate in virtual globe (WorldWind for example) to find it !</li>
<li>Check the pose estimation by opening the 3D viewer. It gets initialized at the current pose estimate when opened.</li>
<li>Below are presented particular cases of reprojection of GCP. It is usual to fall in one of these cases.</li>
</ul>
<table border="1" class="docutils" id="my-drawn-table-2">
<colgroup>
<col width="12%" />
<col width="43%" />
<col width="45%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Description</td>
<td>Most GCP are reprojected near the camera position</td>
<td>Reprojection fall too far from the GCP</td>
</tr>
<tr class="row-even"><td>Image</td>
<td><a class="first last reference internal image-reference" href="_images/behindMountain.png"><img alt="_images/behindMountain.png" src="_images/behindMountain.png" style="height: 200px;" /></a>
</td>
<td><a class="first last reference internal image-reference" href="_images/reprojectOnOtherMoutains.png"><img alt="_images/reprojectOnOtherMoutains.png" src="_images/reprojectOnOtherMoutains.png" style="height: 200px;" /></a>
</td>
</tr>
<tr class="row-odd"><td>Solution</td>
<td>You position fall behind a mountain.
Fix your position with <tt class="kbd docutils literal"><span class="pre">Alt</span> <span class="pre">+</span> <span class="pre">Left</span> <span class="pre">Click</span></tt>:
in 3D view</td>
<td>It&#8217;s not a problem if the GCPs are on top on Hill
There are just reprojected few meters above the top.
Change also GCP in canvas if you change them in
picture</td>
</tr>
</tbody>
</table>
<p><em>About the monoplotter</em>:</p>
<ul class="simple">
<li>Depending on the number of layer in the canvas, the refreshment of the monoplotter can take some times. You will not have any problems if the features are away from your DEM (they become clipped as well as features behind the camera).</li>
<li>Polygons are not yet supported by the monoplotter. It may comes in few months...</li>
<li>Don&#8217;t try to use complex symbology.</li>
<li>During the draping, don&#8217;t choose a too small resolution. It may not be supported if the ratio - (#pixels in DEM * DEM resolution) / resolution of orthoimage - is too high.</li>
<li>The measure tool doesn&#8217;t measure in the picture directly. It projects the click of the mouse in the canvas. So the measure is, in reality, done in the canvas. This implies a strange behavior: if you want to do precise measurement in the picture, you have to zoom at the right place in the canvas.</li>
<li>The same as previous point is worth for digitalization of new features.</li>
</ul>
</div>
<div class="section" id="technical-documentation">
<span id="index-21"></span><h1>Technical documentation<a class="headerlink" href="#technical-documentation" title="Permalink to this headline">¶</a></h1>
<p>A more detailed documentation with equations can be asked to <a class="reference external" href="mailto:gillian&#46;milani&#37;&#52;&#48;epfl&#46;ch">gillian<span>&#46;</span>milani<span>&#64;</span>epfl<span>&#46;</span>ch</a></p>
<div class="section" id="id1">
<h2>Pose estimation<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>In this section will be presented the algorithms used for the pose estimation using GCP. In brief, the Direct Linear Transform (DLT) algorithm is used
for the initial guess of the pose. Then a least square algorithm is used for the purpose of fixing known parameters and refining.</p>
<p>The DLT algorithm give H, the homographic projection in U = H * X where U is a pixel coordinates, X a coordinates in 3D space. The first challenge is therefore to implement
the DLT, which is not so hard. Then, a more complex question is to get the projections parameters from H. The rotation matrix is not trivial to extract.
The position is also related to the rotation estimates. The extraction of the rotation matrix can change radically with few changed in GCP positions.
A first estimate of rotation matrix is extracted according to the DLT equations.
Then a cholesky factorization is applied in order to shape the estimate in a real rotation matrix</p>
<p>According to the co-linearity equation, parameters are the position (x,y,z), the orientation (t,h,s) the focal (f) and the central point (u0, v0).
For the work with openGL, it was sensefull to fix the u0 and v0 at 0. This is the reason of applying the least square algorithm even when the user doesn&#8217;t fix some parameters.
Or in other words, the central point is always fixed to zero after the DLT calculation.</p>
<p>The least square variant implemented is the algorithm of Levenberg-Marquardt. With such an implementation, we raise the stability of the least square approach,
which is very unstable in our case due to the high non-linearity of the co-linearity equation. On the other hands, we keep high performances compared to a
standard gradient approach since some parameters, as the rotation, can change quite a lot between the first DLT estimate and the least square results.</p>
</div>
<div class="section" id="qgis-interactions">
<h2>QGis Interactions<a class="headerlink" href="#qgis-interactions" title="Permalink to this headline">¶</a></h2>
<p>Under the principal of extension, a plugin has to reuse as much as possible tools already available in the software.
The available modules of QGis have been mainly helpful in the case of layers visualization and layer digitalization.</p>
<p>In the first case, a loop crosses all symbology layers and store information about width, color, categories and graduation.
Then a second loop crosses the layer and tests if a feature is visible or not. If it is visible, it keeps trace of the symbology in an index array.
In the painting loop, each feature is drawn according to the geometry stored in an array and the symbology is selected according to the index array.</p>
<p>When a new feature is created in the picture, the feature is not directly created according to the projection.
A virtual click is created on the canvas at the projected coordinates. With such a virtual click, it is guaranteed  to get the same behavior as if the click would be
done directly on the canvas.</p>
<p>The measure tool is currently affected by some implementation  difficulties.</p>
</div>
<div class="section" id="opengl-integration">
<h2>OpenGL Integration<a class="headerlink" href="#opengl-integration" title="Permalink to this headline">¶</a></h2>
<p>OpenGL is the central trunk of the plugin. Here are some explanations about what happens in reality in the monoplotter.
It will be clear as spring water if you have already used the 3D approach for pose estimation.</p>
<p>In the monoplotter, the picture is drawn in the background. Then the DEM is created exactly as in the 3D viewer. The camera is initialized  at the previous pose estimate.
Finally the DEM is set as completely transparent.
So when you digitalize new features or do some measurements, you think you&#8217;re clicking on the picture, but in fact, you&#8217;re clicking on the DEM which is transparent in front of the picture!</p>
<p>If you are interested in the creating of 3D view with DEM, the code is open source and you can enjoy it. If you find the code harsh to read, you can send me an email.</p>
<p>The first progress bar, after the initialization, taks time for normal calculation, in case you don&#8217;t have an orthoimage.
We need to calculate the normals for the purposes of shading the DEM. We could use a standard tool of qgis (gdal) for shaded DEM, But knowing the focal
allows to enable lightning in opengl. The shadows move therefore with the camera, which ensure a good enlightenment  wherever is the pose estimate.</p>
</div>
<div class="section" id="draping">
<h2>Draping<a class="headerlink" href="#draping" title="Permalink to this headline">¶</a></h2>
<p>In brief, you give a picture coordinates at each DEM Vertex.
The DEM triangles formed by three vertices is filled with a stretched image given the coordinates of the vertex.
So it is possible to get a better color resolution than the DEM resolution.</p>
<a class="reference internal image-reference" href="_images/draping.png"><img alt="_images/draping.png" class="align-center" src="_images/draping.png" style="width: 400px;" /></a>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Welcome to Pic2Map&#8217;s documentation!</a></li>
<li><a class="reference internal" href="#concepts">Concepts</a></li>
<li><a class="reference internal" href="#installation-and-testing-dataset">Installation and testing dataset</a></li>
<li><a class="reference internal" href="#system-requirement">System requirement</a></li>
<li><a class="reference internal" href="#data-requirement">Data requirement</a></li>
<li><a class="reference internal" href="#initialization">Initialization</a></li>
<li><a class="reference internal" href="#pose-estimation">Pose estimation</a><ul>
<li><a class="reference internal" href="#gcp-approach">GCP approach</a><ul>
<li><a class="reference internal" href="#the-scene">The Scene</a></li>
<li><a class="reference internal" href="#the-gcp-table">The GCP table</a></li>
<li><a class="reference internal" href="#the-gcp-toolbar">The GCP Toolbar</a></li>
<li><a class="reference internal" href="#the-scene-toolbar">The scene toolbar</a></li>
<li><a class="reference internal" href="#the-3d-toolbar">The 3D toolbar</a></li>
</ul>
</li>
<li><a class="reference internal" href="#virtual-3d-approach">Virtual 3D approach</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monoplotter">Monoplotter</a><ul>
<li><a class="reference internal" href="#visualization-of-layers">Visualization of layers</a></li>
<li><a class="reference internal" href="#digitalization">Digitalization</a></li>
<li><a class="reference internal" href="#measurements">Measurements</a></li>
<li><a class="reference internal" href="#ortho-rectification-draping">Ortho rectification (Draping)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tricks-for-a-comfortable-experience">Tricks for a comfortable experience</a></li>
<li><a class="reference internal" href="#technical-documentation">Technical documentation</a><ul>
<li><a class="reference internal" href="#id1">Pose estimation</a></li>
<li><a class="reference internal" href="#qgis-interactions">QGis Interactions</a></li>
<li><a class="reference internal" href="#opengl-integration">OpenGL Integration</a></li>
<li><a class="reference internal" href="#draping">Draping</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">Pic2Map 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, field: Gillian Milani.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>